<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DC Valuation Table</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #28a745;
      --primary-dark: #1e7e34;
      --secondary: #20c997;
      --light-bg: #f8f9fa;
      --dark-text: #212529;
      --light-text: #6c757d;
      --border-radius: 10px;
      --card-shadow: 0 5px 15px rgba(0,0,0,0.05), 0 3px 5px rgba(0,0,0,0.05);
      --transition: all 0.2s ease;
    }
    
    body { 
      background: var(--light-bg); 
      font-family: 'Inter', sans-serif;
      color: var(--dark-text);
      padding: 12px;
    }
    
    .app-container {
      max-width: 1400px;
      margin: 0 auto;
      background: #fff;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
    }
    
    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(0,0,0,0.06);
    }
    
    .app-title {
      font-size: 1.6rem;
      font-weight: 700;
      color: var(--primary-dark);
      margin: 0;
    }
    
    .mode-selector {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .mode-btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      transition: var(--transition);
      border: 2px solid transparent;
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 0.95rem;
    }
    
    .mode-btn.active {
      border-color: var(--primary);
      background-color: rgba(40, 167, 69, 0.1);
    }
    
    .btn-rural {
      background: linear-gradient(145deg, #e8f5e9, #c8e6c9);
      color: #2e7d32;
    }
    
    .btn-urban {
      background: linear-gradient(145deg, #e0f2f1, #b2dfdb);
      color: #00695c;
    }
    
    .filters-card {
      background: #fff;
      border-radius: var(--border-radius);
      padding: 16px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      transition: var(--transition);
    }
    
    .filter-row {
      margin-bottom: 12px;
    }
    
    .filter-label {
      font-weight: 500;
      margin-bottom: 6px;
      color: var(--dark-text);
      font-size: 0.9rem;
    }
    
    .form-select {
      border-radius: 6px;
      padding: 8px 10px;
      border: 1px solid #dee2e6;
      transition: var(--transition);
      font-size: 0.9rem;
    }
    
    .form-select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.15);
    }
    
    .table-container {
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      margin-bottom: 15px;
      overflow-x: auto;
    }
    
    .table {
      margin-bottom: 0;
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
      min-width: 800px;
    }
    
    .table thead th {
      background: var(--primary);
      color: white;
      font-weight: 600;
      padding: 12px 10px;
      border: none;
      position: sticky;
      top: 0;
      z-index: 10;
      font-size: 0.9rem;
    }
    
    .table tbody td {
      padding: 10px;
      vertical-align: middle;
      border-bottom: 1px solid #f1f3f9;
      font-size: 0.9rem;
      white-space: nowrap;
    }
    
    .table tbody tr {
      transition: var(--transition);
    }
    
    .table tbody tr:hover {
      background-color: #e8f5e9;
    }
    
    .highlight-col {
      background: rgba(255, 99, 71, 0.15) !important; /* Changed to light red */
      font-weight: 600;
      color: #0a58ca;
    }
    
    .action-col {
      position: sticky;
      right: 0;
      background: #fff;
      z-index: 5;
      min-width: 120px;
      text-align: center;
      box-shadow: -3px 0 5px rgba(0,0,0,0.02);
    }
    
    .btn-calc {
      background: linear-gradient(to right, #28a745, #1e7e34);
      color: white;
      border: none;
      border-radius: 5px;
      padding: 6px 12px;
      font-weight: 500;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: 0.85rem;
    }
    
    .btn-calc:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 5px rgba(40, 167, 69, 0.2);
    }
    
    .global-controls {
      display: flex;
      gap: 15px;
      background: #f8f9ff;
      padding: 12px;
      border-radius: var(--border-radius);
      margin-bottom: 15px;
    }
    
    .form-check-input:checked {
      background-color: var(--primary);
      border-color: var(--primary);
    }
    
    .form-switch .form-check-input {
      width: 40px;
      height: 20px;
    }
    
    .rows-control {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #f8f9ff;
      padding: 8px 12px;
      border-radius: var(--border-radius);
      width: fit-content;
      margin-left: auto;
      font-size: 0.9rem;
    }
    
    .loaded-check {
      display: none;
      color: #28a745;
      font-weight: bold;
      margin-left: 5px;
    }
    
    .btn.loaded .loaded-check {
      display: inline;
    }
    
    .dropdown-select {
      padding: 5px;
      border-radius: 4px;
      border: 1px solid #ddd;
      font-size: 0.9rem;
      width: 90px;
    }
    
    .compact-col {
      width: 1%;
      white-space: nowrap;
    }
    
    @media (max-width: 992px) {
      .app-container {
        padding: 15px;
      }
      
      .app-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
      
      .global-controls {
        flex-direction: column;
        gap: 10px;
      }
    }
    
    @media (max-width: 768px) {
      .filter-row .col {
        margin-bottom: 12px;
      }
      
      .mode-btn {
        padding: 8px 15px;
        font-size: 0.9rem;
      }
      
      body {
        padding: 8px;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="app-header">
      <h1 class="app-title"><i class="fas fa-table me-2"></i>DC Valuation Table</h1>
      <!-- Removed the 5% increase toggle button -->
    </div>

    <div class="mode-selector">
      <button id="show-rural" class="btn btn-rural mode-btn">
        <i class="fas fa-tree"></i> Rural 
        <span class="loaded-check">✔</span>
      </button>
      <button id="show-urban" class="btn btn-urban mode-btn">
        <i class="fas fa-building"></i> Urban
        <span class="loaded-check">✔</span>
      </button>
    </div>

    <!-- RURAL -->
    <div id="rural-section" class="section" style="display:none;">
      <input type="file" id="rural-file" class="d-none" accept=".csv,.xls,.xlsx" />
      <div id="rural-filters" class="filters-card" style="display:none;">
        <h5 class="mb-3"><i class="fas fa-filter me-2"></i>Filters</h5>
        <div class="row g-2 filter-row">
          <div class="col-md-6 col-lg-3">
            <div class="filter-label">Tehsil</div>
            <select id="rural-Tehsil" class="form-select"></select>
          </div>
          <div class="col-md-6 col-lg-3">
            <div class="filter-label">Qanoongoi</div>
            <select id="rural-Qanoongoi" class="form-select" disabled></select>
          </div>
          <div class="col-md-6 col-lg-3">
            <div class="filter-label">Mauza</div>
            <select id="rural-Mauza" class="form-select" disabled></select>
          </div>
          <div class="col-md-6 col-lg-3">
            <div class="filter-label">Classification</div>
            <select id="rural-Classification" class="form-select" disabled></select>
          </div>
          <div class="col-md-6 col-lg-3">
            <div class="filter-label">Location</div>
            <select id="rural-Location" class="form-select" disabled></select>
          </div>
        </div>
      </div>
      <div id="rural-data" class="data-display" style="display:none;">
        <div class="table-container">
          <table class="table">
            <thead id="rural-thead"></thead>
            <tbody id="rural-tbody"></tbody>
          </table>
        </div>
        <div class="rows-control">
          <span>Show</span>
          <select id="rural-rowsperpage" class="form-select rows-select">
            <option value="5" selected>5 rows</option>
            <option value="10">10 rows</option>
            <option value="15">15 rows</option>
            <option value="20">20 rows</option>
            <option value="25">25 rows</option>
            <option value="all">All rows</option>
          </select>
          <span>per page</span>
        </div>
      </div>
    </div>

    <!-- URBAN -->
    <div id="urban-section" class="section" style="display:none;">
      <input type="file" id="urban-file" class="d-none" accept=".csv,.xls,.xlsx" />
      <div id="urban-filters" class="filters-card" style="display:none;">
        <h5 class="mb-3"><i class="fas fa-filter me-2"></i>Filters</h5>
        <div class="row g-2 filter-row">
          <div class="col-md-6 col-lg-3">
            <div class="filter-label">Town</div>
            <select id="urban-Town" class="form-select"></select>
          </div>
          <div class="col-md-6 col-lg-3">
            <div class="filter-label">Revenue Circle</div>
            <select id="urban-RevenueCircle" class="form-select" disabled></select>
          </div>
          <div class="col-md-6 col-lg-3">
            <div class="filter-label">Property Area</div>
            <select id="urban-PropertyArea" class="form-select" disabled></select>
          </div>
          <div class="col-md-6 col-lg-3">
            <div class="filter-label">Classification</div>
            <select id="urban-Classification" class="form-select" disabled></select>
          </div>
          <div class="col-md-6 col-lg-3">
            <div class="filter-label">Location</div>
            <select id="urban-Location" class="form-select" disabled></select>
          </div>
        </div>
      </div>
      <div id="urban-data" class="data-display" style="display:none;">
        <div class="table-container">
          <table class="table">
            <thead id="urban-thead"></thead>
            <tbody id="urban-tbody"></tbody>
          </table>
        </div>
        <div class="rows-control">
          <span>Show</span>
          <select id="urban-rowsperpage" class="form-select rows-select">
            <option value="5" selected>5 rows</option>
            <option value="10">10 rows</option>
            <option value="15">15 rows</option>
            <option value="20">20 rows</option>
            <option value="25">25 rows</option>
            <option value="all">All rows</option>
          </select>
          <span>per page</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Calculator Modal -->
  <div class="modal fade" id="calculatorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fas fa-calculator me-2"></i>Calculator</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" style="padding:0;">
          <iframe id="calculatorFrame" src="Calculator.html" style="width:100%;height:450px;border:0;"></iframe>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Your existing JavaScript code with modifications
    const cachedData={rural:null,urban:null};

    document.getElementById("show-rural").addEventListener("click",()=>{
      document.getElementById("rural-section").style.display="block";
      document.getElementById("urban-section").style.display="none";
      if(!cachedData.rural)document.getElementById("rural-file").click();
      else ruralRender();
      
      // Update active state
      document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById("show-rural").classList.add('active');
    });
    
    document.getElementById("show-urban").addEventListener("click",()=>{
      document.getElementById("urban-section").style.display="block";
      document.getElementById("rural-section").style.display="none";
      if(!cachedData.urban)document.getElementById("urban-file").click();
      else urbanRender();
      
      // Update active state
      document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById("show-urban").classList.add('active');
    });

    function formatIndian(num){if(num==null)return"";let x=String(num).split('.');let int=x[0];let last=int.substring(int.length-3);let other=int.substring(0,int.length-3);if(other!='')last=','+last;other=other.replace(/\B(?=(\d{2})+(?!\d))/g,",");return(other+last)+(x[1]?'.'+x[1]:'');}

    // Function to parse number strings (ranges and semicolon separated)
    function parseNumberString(str) {
      if (!str) return [];
      const parts = String(str).split(';').map(part => part.trim());
      let numbers = [];
      
      for (const part of parts) {
        if (part.includes('-')) {
          const [start, end] = part.split('-').map(n => parseInt(n.trim()));
          if (!isNaN(start) && !isNaN(end)) {
            for (let i = start; i <= end; i++) {
              numbers.push(i);
            }
          }
        } else {
          const num = parseInt(part);
          if (!isNaN(num)) numbers.push(num);
        }
      }
      
      // Remove duplicates and sort
      return [...new Set(numbers)].sort((a, b) => a - b);
    }

    function buildHandlers(prefix,filterOrder){
      let rawData=[],filteredData=[],headers=[];
      const fileInput=document.getElementById(`${prefix}-file`);
      const filterSection=document.getElementById(`${prefix}-filters`);
      const dataSection=document.getElementById(`${prefix}-data`);
      const dataThead=document.getElementById(`${prefix}-thead`);
      const dataTbody=document.getElementById(`${prefix}-tbody`);
      const rowsPerPageSelect=document.getElementById(`${prefix}-rowsperpage`);
      const filterSelects={}; filterOrder.forEach(k=>filterSelects[k]=document.getElementById(`${prefix}-${k.replace(/ /g,"")}`));

      fileInput.addEventListener("change",e=>{
        const file=e.target.files[0]; if(!file) return;
        const ext=file.name.split('.').pop().toLowerCase();
        const handle=(data,hdrs)=>{
          // Filter out unwanted columns for both rural and urban data
          data = data.map(row => {
            const newRow = {...row};
            // Remove unwanted columns
            for (const key in newRow) {
              // Remove SR. NO. column (case insensitive)
              if (key.toLowerCase().includes("sr.") || key.toLowerCase().includes("sr no")) {
                delete newRow[key];
              }
              if(prefix === "rural") {
                // Remove Khasra No for rural
                if(key.toLowerCase().includes("khasra")) delete newRow[key];
              } else if(prefix === "urban") {
                // Remove only Khasra No for urban (keep Killa No)
                if(key.toLowerCase().includes("khasra")) delete newRow[key];
              }
            }
            return newRow;
          });
          
          // Update headers to exclude unwanted columns
          hdrs = hdrs.filter(header => {
            // Remove SR. NO. column (case insensitive)
            if (header.toLowerCase().includes("sr.") || header.toLowerCase().includes("sr no")) return false;
            if(prefix === "rural") {
              // Remove Khasra No for rural
              if(header.toLowerCase().includes("khasra")) return false;
            } else if(prefix === "urban") {
              // Remove only Khasra No for urban (keep Killa No)
              if(header.toLowerCase().includes("khasra")) return false;
            }
            return true;
          });
          
          rawData=data.filter(r=>Object.values(r).some(v=>String(v).trim()!=""));
          headers=hdrs;
          cachedData[prefix]={ raw: rawData, headers: headers };
          filterSection.style.display="block"; filterSection.dataset.loaded="true"; resetFilters(); populateFilters(filterOrder[0],rawData);
          document.getElementById(`show-${prefix}`).classList.add("loaded");
          
          // After loading, set Depalpur as default for rural Tehsil
          if (prefix === "rural") {
            const tehsilSelect = document.getElementById("rural-Tehsil");
            if (tehsilSelect) {
              // Check if Depal Pur exists in the options
              const DepalpurOption = Array.from(tehsilSelect.options).find(opt => opt.text === "Depal Pur");
              if (DepalpurOption) {
                tehsilSelect.value = "Depal Pur";
                // Trigger change to update subsequent filters
                tehsilSelect.dispatchEvent(new Event('change'));
              }
            }
          }
        };
        if(ext==="csv"){Papa.parse(file,{header:true,complete:res=>handle(res.data,res.meta.fields)});}
        else {const reader=new FileReader();reader.onload=ev=>{const wb=XLSX.read(new Uint8Array(ev.target.result),{type:"array"});const sheet=wb.Sheets[wb.SheetNames[0]];const json=XLSX.utils.sheet_to_json(sheet,{defval:""});handle(json,Object.keys(json[0]||{}));};reader.readAsArrayBuffer(file);}
      });

      function resetFilters(){filterOrder.forEach((k,i)=>{const sel=filterSelects[k];if(!sel)return;sel.innerHTML=`<option value="">Select ${k}</option>`;sel.disabled=i!==0;});dataSection.style.display="none";filteredData=[];}

      function populateFilters(key,data){
        const sel=filterSelects[key];
        if(!sel)return;
        const vals=[...new Set(data.map(r=>r[key]).filter(v=>String(v).trim()!=""))].sort();
        sel.innerHTML=`<option value="">Select ${key}</option>`+vals.map(v=>`<option>${v}</option>`).join("");
        sel.disabled=false;
      }

      function updateFilters(e){
        const key=filterOrder.find(k=>`${prefix}-${k.replace(/ /g,"")}`===e.target.id);
        const idx=filterOrder.indexOf(key);
        let subset=rawData.slice();
        for(let i=0;i<=idx;i++){let k=filterOrder[i],v=filterSelects[k].value;if(v)subset=subset.filter(r=>String(r[k])==String(v));}
        if(idx+1<filterOrder.length)populateFilters(filterOrder[idx+1],subset);
        filteredData=subset;

        if (key === "Classification" || key === "Location") {
          rowsPerPageSelect.value = "5";
          renderTable();
          dataSection.style.display="block";
        }
      }

      function renderTable(){
        dataThead.innerHTML="";dataTbody.innerHTML="";
        if(!filteredData.length){dataTbody.innerHTML="<tr><td>No data</td></tr>";return;}
        
        // Always show all columns
        const displayed = headers;
        const hr=document.createElement("tr");
        displayed.forEach(h=>{
          const th=document.createElement("th");
          th.textContent=h;
          // Make Square No. and Killa No. columns more compact
          if (h === "Square No" || h === "Killa No" || h === "Khasra No") {
            th.classList.add("compact-col");
          }
          // This is where the header color is set - modify this condition
          // to exclude "DC Rate" from getting the highlight-col class
          if(h.toLowerCase().includes("dc rate") && !h.includes("")) {
            th.classList.add("highlight-col");
          }
          hr.appendChild(th);
        });
        const act=document.createElement("th");act.textContent="Action";act.className="action-col";hr.appendChild(act);
        dataThead.appendChild(hr);

        // Check if Classification filter is applied
        const classificationFilterApplied = filterSelects['Classification'] && filterSelects['Classification'].value;
        
        const rowsValue = rowsPerPageSelect.value;
        const dataToRender = rowsValue === "all" ? filteredData : filteredData.slice(0, parseInt(rowsValue));
        
        if (classificationFilterApplied) {
          // Show all rows with dropdowns for Square No. and Killa/Khasra No.
          dataToRender.forEach(r=>{
            const tr=document.createElement("tr");let dc=null;
            
            displayed.forEach(h=>{
              const td=document.createElement("td");
              let v=r[h];
              
              // Add compact class to these columns
              if (h === "Square No" || h === "Killa No" || h === "Khasra No") {
                td.classList.add("compact-col");
              }
              
              if(h === 'Square No'){
                // Create dropdown for Square No.
                const select = document.createElement("select");
                select.className = "dropdown-select";
                const numbers = parseNumberString(v);
                select.innerHTML = '<option value="">Square No.</option>' + 
                  numbers.map(num => `<option value="${num}">${num}</option>`).join('');
                td.appendChild(select);
              } 
              else if (h === 'Killa No' && prefix === 'rural') {
                // Create dropdown for Killa No. for rural
                const select = document.createElement("select");
                select.className = "dropdown-select";
                const numbers = parseNumberString(v);
                select.innerHTML = '<option value="">Killa No.</option>' + 
                  numbers.map(num => `<option value="${num}">${num}</option>`).join('');
                td.appendChild(select);
              }
              else if (h === 'Killa No' && prefix === 'urban') {
                // Create dropdown for Killa No. for urban
                const select = document.createElement("select");
                select.className = "dropdown-select";
                const numbers = parseNumberString(v);
                select.innerHTML = '<option value="">Killa No.</option>' + 
                  numbers.map(num => `<option value="${num}">${num}</option>`).join('');
                td.appendChild(select);
              }
              else if(h.toLowerCase().includes("dc rate")){
                let num=parseFloat(String(v).replace(/,/g,""));
                if(!isNaN(num)){dc=Math.round(num);td.textContent=formatIndian(dc);}
                else td.textContent=v;
                td.classList.add("highlight-col");
              } else {
                td.textContent=v||"";
              }
              
              tr.appendChild(td);
            });
            
            const tda=document.createElement("td");tda.className="action-col";
            const btn=document.createElement("button");btn.className="btn btn-sm btn-calc";btn.innerHTML = "<i class='fas fa-calculator me-1'></i> Calculate";
            if(dc){
              const unitKey = prefix === "rural" ? "Unit" : "Unit";
              const unitOfMeasure = r[unitKey] || "";
              btn.onclick = ()=>openCalculator(r, prefix);
            } else btn.disabled=true;
            tda.appendChild(btn);tr.appendChild(tda);dataTbody.appendChild(tr);
          });
        } else {
          // Original rendering logic when Classification filter is not applied
          dataToRender.forEach(r=>{
            const tr=document.createElement("tr");let dc=null;
            displayed.forEach(h=>{
              const td=document.createElement("td");
              let v=r[h];
              
              // Add compact class to these columns
              if (h === "Square No" || h === "Killa No" || h === "Khasra No") {
                td.classList.add("compact-col");
              }
              
              if(h.toLowerCase().includes("dc rate")){
                let num=parseFloat(String(v).replace(/,/g,""));
                if(!isNaN(num)){dc=Math.round(num);td.textContent=formatIndian(dc);}
                else td.textContent=v;
                td.classList.add("highlight-col");
              } else td.textContent=v||"";
              tr.appendChild(td);
            });
            const tda=document.createElement("td");tda.className="action-col";
            const btn=document.createElement("button");btn.className="btn btn-sm btn-calc";btn.innerHTML = "<i class='fas fa-calculator me-1'></i> Calculate";
            if(dc){
              const unitKey = prefix === "rural" ? "Unit" : "Unit";
              const unitOfMeasure = r[unitKey] || "";
              btn.onclick = ()=>openCalculator(r, prefix);
            } else btn.disabled=true;
            tda.appendChild(btn);tr.appendChild(tda);dataTbody.appendChild(tr);
          });
        }
      }

      filterOrder.forEach(k=>{const sel=filterSelects[k];if(sel)sel.addEventListener("change",updateFilters);});
      rowsPerPageSelect.addEventListener("change",renderTable);
      window[`${prefix}Render`]=renderTable;
    }

    // Updated filter order for rural (starting with Tehsil instead of District)
    buildHandlers("rural",["Tehsil","Qanoongoi","Mauza","Classification","Location"]);
    // Updated filter order for urban (starting with Town instead of District/Tehsil)
    buildHandlers("urban",["Town","Revenue Circle","Property Area","Classification","Location"]);

    function openCalculator(rowData, sourceType){
      const modalEl = document.getElementById("calculatorModal");
      const modal=new bootstrap.Modal(modalEl);
      const iframe=document.getElementById("calculatorFrame");

      // Prepare data to send to calculator
      let dataToSend = {
        sourceType: sourceType
      };

      // Add specific fields based on rural/urban
      if (sourceType === 'rural') {
        dataToSend.mauza = rowData['Mauza'] || '';
        dataToSend.classification = rowData['Classification'] || '';
        dataToSend.location = rowData['Location'] || '';
        dataToSend.dcRate = parseFloat(String(rowData['DC Rate']).replace(/,/g, "")) || 0;
        dataToSend.unit = rowData['Unit'] || '';
        dataToSend.structureRate = parseFloat(String(rowData['Structure Rate']).replace(/,/g, "")) || 0;
      } else if (sourceType === 'urban') {
        dataToSend.propertyArea = rowData['Property Area'] || '';
        dataToSend.classification = rowData['Classification'] || '';
        dataToSend.location = rowData['Location'] || '';
        dataToSend.dcRate = parseFloat(String(rowData['DC Rate']).replace(/,/g, "")) || 0;
        dataToSend.unit = rowData['Unit'] || '';
        dataToSend.structureRate = parseFloat(String(rowData['Structure Rate']).replace(/,/g, "")) || 0;
      }

      function send(){
        try{
          iframe.contentWindow.postMessage(dataToSend,"*");
        }catch(e){}
      }

      iframe.removeEventListener('load', send);
      iframe.addEventListener('load', send);

      modal.show();
      send();
      setTimeout(send, 200);
      setTimeout(send, 600);
      setTimeout(send, 1200);
    }
  </script>
</body>
</html>