<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Land Calculator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary: #28a745;
            --primary-dark: #1e7e34;
            --secondary: #20c997;
            --light-bg: #f8f9fa;
            --card-bg: #ffffff;
            --text-dark: #212529;
            --text-light: #6c7280;
            --border-color: #e2e8f0;
            --success: #4cc9f0;
            --error: #ef4444;
            --border-radius: 12px;
            --border-radius-sm: 8px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --transition: all 0.3s ease;
            --accent: #4f46e5;
            --accent-light: #818cf8;
            --property-bg: #e8f5e9;
            --client-bg: #e3f2fd;
            --charges-bg: #fff3e0;
            --total-bg: #f3e5f5;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--light-bg);
            color: var(--text-dark);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .calculator-container {
            width: 100%;
            max-width: 900px;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        
        .calculator-header {
            background: linear-gradient(145deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .calculator-header::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            background: linear-gradient(45deg, var(--primary) 0%, var(--primary-dark) 50%, var(--secondary) 100%);
            z-index: -1;
            filter: blur(20px);
            opacity: 0.7;
        }
        
        .calculator-header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0;
            letter-spacing: 0.5px;
        }
        
        .calculator-body {
            padding: 25px;
        }
        
        .input-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .input-group label {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-dark);
            display: flex;
            align-items: center;
        }
        
        .input-group input {
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            font-size: 1rem;
            transition: var(--transition);
            font-weight: 600;
            background: #fff;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.2);
        }
        
        .input-group input[readonly] {
            background-color: #f8f9fa;
            color: var(--text-dark);
            font-weight: 600;
        }
        
        .radio-group {
            display: flex;
            gap: 15px;
            margin-top: 5px;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
            color: var(--text-light);
        }
        
        .radio-option input[type="radio"] {
            appearance: none;
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            transition: var(--transition);
            cursor: pointer;
        }
        
        .radio-option input[type="radio"]:checked {
            background-color: var(--primary);
            border-color: var(--primary);
        }
        
        .radio-option input[type="radio"]:checked::after {
            content: '';
            width: 6px;
            height: 6px;
            background-color: white;
            border-radius: 50%;
        }
        
        .checkbox-group {
            display: flex;
            gap: 15px;
            margin-top: 5px;
        }
        
        .checkbox-option {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
            color: var(--text-light);
        }
        
        .checkbox-option input[type="checkbox"] {
            appearance: none;
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-color);
            border-radius: 3px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            transition: var(--transition);
            cursor: pointer;
        }
        
        .checkbox-option input[type="checkbox"]:checked {
            background-color: var(--primary);
            border-color: var(--primary);
        }
        
        .checkbox-option input[type="checkbox"]:checked::after {
            content: 'âœ“';
            color: white;
            font-size: 10px;
            line-height: 1;
        }
        
        .output-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .output-group {
            background: linear-gradient(to bottom right, #f8f9ff, #f0f4ff);
            border-radius: var(--border-radius-sm);
            padding: 15px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .output-group label {
            display: block;
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 8px;
            color: var(--text-dark);
        }
        
        .output-value {
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--primary-dark);
            text-align: right;
        }
        
        .fee-percentage {
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 5px;
            font-weight: 500;
        }
        
        .final-amount {
            background: linear-gradient(145deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 25px;
            border-radius: var(--border-radius);
            text-align: center;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }
        
        .final-amount::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            background: linear-gradient(45deg, var(--primary) 0%, var(--primary-dark) 50%, var(--secondary) 100%);
            z-index: -1;
            filter: blur(15px);
            opacity: 0.6;
        }
        
        .final-amount h3 {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
            letter-spacing: 0.5px;
        }
        
        .final-amount .amount {
            font-size: 2.4rem;
            font-weight: 700;
            letter-spacing: 1px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .btn {
            padding: 12px 25px;
            border-radius: var(--border-radius-sm);
            border: none;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .btn-print {
            background: linear-gradient(to right, var(--primary), var(--primary-dark));
            color: white;
        }
        
        .btn-print:hover {
            background: linear-gradient(to right, var(--primary-dark), var(--primary));
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .btn-reset {
            background: linear-gradient(to right, #6b7280, #4b5563);
            color: white;
        }
        
        .btn-reset:hover {
            background: linear-gradient(to right, #4b5563, #374151);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            width: 90%;
            max-width: 450px;
            box-shadow: var(--shadow);
            position: relative;
        }
        
        .modal-header {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .modal-header h2 {
            font-size: 1.6rem;
            color: var(--primary-dark);
            font-weight: 700;
        }
        
        .modal-body {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .modal-input {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .modal-input label {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-dark);
        }
        
        .modal-input input {
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            font-size: 1rem;
            transition: var(--transition);
        }
        
        .modal-input input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.2);
        }
        
        .modal-input input:disabled {
            background-color: #f3f4f6;
            color: var(--text-dark);
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .btn-cancel {
            background: #6b7280;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }
        
        .btn-cancel:hover {
            background: #4b5563;
        }
        
        .btn-download {
            background: var(--primary);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }
        
        .btn-download:hover {
            background: var(--primary-dark);
        }
        
        /* Structure section styles */
        .structure-section {
            margin-bottom: 25px;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background: linear-gradient(to bottom right, #f9f9f9, #f0f0f0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .structure-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .structure-header h3 {
            font-size: 1.1rem;
            margin-left: 10px;
            font-weight: 600;
        }
        
        .structure-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .structure-input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .structure-input-group label {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-dark);
        }
        
        .structure-input-group input {
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            font-size: 1rem;
            transition: var(--transition);
            font-weight: 600;
        }
        
        .structure-input-group input[readonly] {
            background-color: #f0f0f0;
        }

        /* Naqsha Fee section */
        .naqsha-section {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .naqsha-section h3 {
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        /* Non-Govt Charges section */
        .non-govt-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .non-govt-group {
            background: linear-gradient(to bottom right, #fff3e0, #ffecb3);
            border-radius: var(--border-radius-sm);
            padding: 15px;
            border: 1px solid #ffd54f;
        }
        
        .non-govt-group label {
            display: block;
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 8px;
            color: var(--text-dark);
        }
        
        .non-govt-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ffd54f;
            border-radius: var(--border-radius-sm);
            font-size: 1rem;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.7);
        }
        
        /* Fee table styling for PDF */
        .fee-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        .fee-table th {
            background-color: #f0f4ff;
            padding: 8px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
        }
        
        .fee-table td {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .fee-table tr:last-child td {
            border-bottom: none;
        }
        
        @media (max-width: 768px) {
            .input-section, .output-section {
                grid-template-columns: 1fr;
            }
            
            .radio-group, .checkbox-group {
                flex-wrap: wrap;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .structure-inputs {
                grid-template-columns: 1fr;
            }
            
            .final-amount .amount {
                font-size: 1.8rem;
            }
            
            .non-govt-section {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="calculator-container">
        <div class="calculator-header">
            <h1><i class="fas fa-calculator"></i> Land Calculator</h1>
        </div>
        
        <div class="calculator-body">
            <div class="input-section">
                <div class="input-group">
                    <label for="landInput"><i class="fas fa-map-marked-alt"></i> Land (K-M-F)</label>
                    <input type="text" id="landInput" placeholder="e.g. 2-5-150">
                </div>
                
                <div class="input-group">
                    <label for="dcRate"><i class="fas fa-tag"></i> DC Rate</label>
                    <input type="text" id="dcRate" placeholder="Enter rate">
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" name="dcType" value="marla" id="marlaOption" checked>
                            <label for="marlaOption">Per Marla</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" name="dcType" value="acre" id="acreOption">
                            <label for="acreOption">Per Acre</label>
                        </div>
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="totalValue"><i class="fas fa-calculator"></i> Total Value (System)</label>
                    <input type="text" id="totalValue" value="0" readonly>
                </div>
                
                <div class="input-group">
                    <label for="customValue"><i class="fas fa-edit"></i> Custom Value</label>
                    <input type="text" id="customValue" value="0">
                </div>
            </div>
            
            <!-- Structure Section -->
            <div class="structure-section">
                <div class="structure-header">
                    <input type="checkbox" id="structureCheckbox">
                    <h3><i class="fas fa-building"></i> Include Structure Value</h3>
                </div>
                
                <div class="structure-inputs" id="structureInputs" style="display: none;">
                    <div class="structure-input-group">
                        <label for="structureRate">Structure Rate</label>
                        <input type="text" id="structureRate" value="0" readonly>
                    </div>
                    
                    <div class="structure-input-group">
                        <label for="totalSquareFeet">Total Square Feet</label>
                        <input type="text" id="totalSquareFeet" value="0">
                    </div>
                    
                    <div class="structure-input-group">
                        <label for="totalStructureValue">Total Structure Value</label>
                        <input type="text" id="totalStructureValue" value="0" readonly>
                    </div>
                </div>
            </div>
            
            <div class="output-section">
                <div class="output-group">
                    <label><i class="fas fa-stamp"></i> Stamp Duty</label>
                    <div class="output-value" id="stampDuty">0</div>
                    <div class="fee-percentage" id="stampPercentage">1%</div>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" name="stamp" value="3" id="stamp3">
                            <label for="stamp3">3%</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" name="stamp" value="1" id="stamp1" checked>
                            <label for 'stamp1'>1%</label>
                        </div>
                    </div>
                </div>
                
                <div class="output-group">
                    <label><i class="fas fa-landmark"></i> Local Government Fee</label>
                    <div class="output-value" id="districtCouncil">0</div>
                    <div class="fee-percentage">1%</div>
                </div>
            </div>
            
            <div class="output-section">
                <div class="output-group">
                    <label><i class="fas fa-file-invoice-dollar"></i> FBR Fee 236C</label>
                    <div class="output-value" id="fbrC">0</div>
                    <div class="fee-percentage" id="fbrCPercentage">-</div>
                    <div class="checkbox-group">
                        <div class="checkbox-option">
                            <input type="checkbox" name="fbrC" value="4.5" id="fbrC4_5">
                            <label for="fbrC4_5">4.5%</label>
                        </div>
                        <div class="checkbox-option">
                            <input type="checkbox" name="fbrC" value="7.5" id="fbrC7_5">
                            <label for="fbrC7_5">7.5%</label>
                        </div>
                        <div class="checkbox-option">
                            <input type="checkbox" name="fbrC" value="11.5" id="fbrC11_5">
                            <label for="fbrC11_5">11.5%</label>
                        </div>
                    </div>
                </div>
                
                <div class="output-group">
                    <label><i class="fas fa-file-invoice-dollar"></i> FBR Fee 236K</label>
                    <div class="output-value" id="fbrK">0</div>
                    <div class="fee-percentage" id="fbrKPercentage">-</div>
                    <div class="checkbox-group">
                        <div class="checkbox-option">
                            <input type="checkbox" name="fbrK" value="1.5" id="fbrK1_5">
                            <label for="fbrK1_5">1.5%</label>
                        </div>
                        <div class="checkbox-option">
                            <input type="checkbox" name="fbrK" value="4.5" id="fbrK4_5">
                            <label for="fbrK4_5">4.5%</label>
                        </div>
                        <div class="checkbox-option">
                            <input type="checkbox" name="fbrK" value="10.5" id="fbrK10_5">
                            <label for="fbrK10_5">10.5%</label>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="output-section">
                <div class="output-group">
                    <label><i class="fas fa-tools"></i> PLRA Service Charges</label>
                    <div class="output-value" id="plraCharges">0</div>
                    <div class="fee-percentage">-</div>
                </div>
                
                <div class="output-group">
                    <label><i class="fas fa-file-signature"></i> Registration Charges</label>
                    <div class="output-value" id="regCharges">1,000</div>
                    <div class="fee-percentage">-</div>
                </div>
            </div>
            
            <!-- Naqsha Fee Section with Checkbox -->
            <div class="output-section">
                <div class="output-group">
                    <div class="naqsha-section">
                        <input type="checkbox" id="naqshaCheckbox">
                        <h3><i class="fas fa-map"></i> Naqsha Fee</h3>
                    </div>
                    <div class="output-value" id="naqshaFee">0</div>
                    <div class="fee-percentage">2%</div>
                </div>
            </div>
            
            <!-- Non-Govt Charges Section -->
            <div class="output-section">
                <div class="non-govt-section">
                    <div class="non-govt-group">
                        <label for="nonGovtCharges1"><i class="fas fa-receipt"></i> Ahl-Commission Fee</label>
                        <input type="text" id="nonGovtCharges1" value="0" placeholder="Enter amount">
                    </div>
                    
                    <div class="non-govt-group">
                        <label for="nonGovtCharges2"><i class="fas fa-receipt"></i> Misc. & Service Charges</label>
                        <input type="text" id="nonGovtCharges2" value="0" placeholder="Enter amount">
                    </div>
                </div>
            </div>
            
            <div class="final-amount">
                <h3>FINAL AMOUNT</h3>
                <div class="amount" id="finalAmount">0</div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-print" id="printBtn">
                    <i class="fas fa-print"></i> Print Quotation
                </button>
                <button class="btn btn-reset" id="resetBtn">
                    <i class="fas fa-redo"></i> Reset
                </button>
            </div>
        </div>
    </div>

    <!-- Modal for client details -->
    <div class="modal" id="quotationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-user-circle"></i> Client Details</h2>
            </div>
            
            <div class="modal-body">
                <div class="modal-input">
                    <label for="clientName">Client Name</label>
                    <input type="text" id="clientName" placeholder="Enter client name">
                </div>
                
                <div class="modal-input">
                    <label for="clientArea">Area</label>
                    <input type="text" id="clientArea" disabled>
                </div>
                
                <div class="modal-input">
                    <label for="clientAddress">Client Address</label>
                    <input type="text" id="clientAddress" placeholder="Enter client address">
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn-cancel" id="modalCancel">Cancel</button>
                <button class="btn-download" id="sendBtn">Download PDF</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables to store current calculation details
        let currentDCRate = "";
        let currentDCType = "marla";
        let currentSourceType = "urban"; // Default to urban
        let structureRate = 0; // Structure Rate from external source
        let isSquareFeetManual = false; // Track if square feet was manually edited
        let systemValue = 0; // Store system value for PDF generation
        let propertyLocation = ""; // Store property location from parent
        let mauzaOrPropertyArea = ""; // Store mauza/property area from parent

        function formatIndian(num) {
            if (typeof num !== 'number') num = Number(num) || 0;
            return Math.round(num).toLocaleString('en-IN');
        }

        function calculate() {
            let land = (document.getElementById('landInput').value || "").trim();
            let parts = land ? land.split("-") : [];
            let K = parseInt(parts[0]) || 0, M = parseInt(parts[1]) || 0, F = parseInt(parts[2]) || 0;
            let totalMarlas = (K * 20) + M + (F / 272);

            let dcRateRaw = (document.getElementById('dcRate').value || "").replace(/,/g, "").trim();
            let dcRate = parseFloat(dcRateRaw) || 0;
            if (dcRateRaw !== "") document.getElementById('dcRate').value = formatIndian(dcRate);

            let dcType = (document.querySelector('input[name="dcType"]:checked') || {}).value || 'marla';
            currentDCType = dcType; // Store for PDF
            
            // Calculate system value based on unit type
            systemValue = 0;
            if (dcType === "marla") {
                systemValue = totalMarlas * dcRate;
            } else {
                // For acre, convert marlas to acres (1 acre = 160 marlas)
                systemValue = (totalMarlas / 160) * dcRate;
            }
            
            // Calculate Naqsha Fee (2% of land value before structure) if enabled
            const naqshaEnabled = document.getElementById('naqshaCheckbox').checked;
            let naqshaFee = naqshaEnabled ? systemValue * 0.02 : 0;
            document.getElementById('naqshaFee').innerText = formatIndian(naqshaFee);
            
            // Calculate structure values if enabled
            const structureEnabled = document.getElementById('structureCheckbox').checked;
            let structureValue = 0;
            
            if (structureEnabled) {
                // Calculate total square feet if not manually edited
                if (!isSquareFeetManual) {
                    // 1 marla = 272.25 sq ft
                    const totalSquareFeet = totalMarlas * 272.25;
                    document.getElementById('totalSquareFeet').value = formatIndian(totalSquareFeet);
                }
                
                // Get square feet value (may be manually edited)
                let squareFeetRaw = (document.getElementById('totalSquareFeet').value || "").replace(/,/g, "").trim();
                let squareFeet = parseFloat(squareFeetRaw) || 0;
                
                // Calculate structure value
                structureValue = squareFeet * structureRate;
                document.getElementById('totalStructureValue').value = formatIndian(structureValue);
                
                // Add structure value to system value
                systemValue += structureValue;
            }
            
            document.getElementById('totalValue').value = formatIndian(systemValue);

            let customRaw = (document.getElementById('customValue').value || "").replace(/,/g,"").trim();
            let customValue = parseFloat(customRaw);
            let baseValue = (!isNaN(customValue) && customValue > 0) ? customValue : systemValue;
            if (!isNaN(customValue)) document.getElementById('customValue').value = formatIndian(customValue);

            // Use 1% stamp duty for urban, 3% for rural
            let stampPercent = parseFloat((document.querySelector('input[name="stamp"]:checked') || {}).value) || 0;
            let stampDuty = (baseValue * stampPercent) / 100;
            document.getElementById('stampDuty').innerText = formatIndian(stampDuty);
            document.getElementById('stampPercentage').innerText = stampPercent + "%";

            let districtCouncil = baseValue * 0.01;
            document.getElementById('districtCouncil').innerText = formatIndian(districtCouncil);

            let fbrCBox = document.querySelector('input[name="fbrC"]:checked');
            let fbrC = fbrCBox ? (baseValue * parseFloat(fbrCBox.value)) / 100 : 0;
            document.getElementById('fbrC').innerText = formatIndian(fbrC);
            document.getElementById('fbrCPercentage').innerText = fbrCBox ? fbrCBox.value + "%" : "-";

            let fbrKBox = document.querySelector('input[name="fbrK"]:checked');
            let fbrK = fbrKBox ? (baseValue * parseFloat(fbrKBox.value)) / 100 : 0;
            document.getElementById('fbrK').innerText = formatIndian(fbrK);
            document.getElementById('fbrKPercentage').innerText = fbrKBox ? fbrKBox.value + "%" : "-";

            let plraCharges = (baseValue <= 3300000) ? 3300 : baseValue * 0.001;
            document.getElementById('plraCharges').innerText = formatIndian(plraCharges);

            let regCharges = 1000;
            
            // Get non-govt charges
            let nonGovtCharges1Raw = (document.getElementById('nonGovtCharges1').value || "").replace(/,/g, "").trim();
            let nonGovtCharges1 = parseFloat(nonGovtCharges1Raw) || 0;
            if (nonGovtCharges1Raw !== "") document.getElementById('nonGovtCharges1').value = formatIndian(nonGovtCharges1);
            
            let nonGovtCharges2Raw = (document.getElementById('nonGovtCharges2').value || "").replace(/,/g, "").trim();
            let nonGovtCharges2 = parseFloat(nonGovtCharges2Raw) || 0;
            if (nonGovtCharges2Raw !== "") document.getElementById('nonGovtCharges2').value = formatIndian(nonGovtCharges2);

            let finalAmount = stampDuty + districtCouncil + fbrC + fbrK + plraCharges + regCharges + naqshaFee + nonGovtCharges1 + nonGovtCharges2;
            document.getElementById('finalAmount').innerText = formatIndian(finalAmount);
        }

        // Checkbox logic
        document.querySelectorAll('input[name="fbrC"]').forEach(cb => cb.addEventListener('change', () => {
            if (cb.checked) document.querySelectorAll('input[name="fbrC"]').forEach(o => { if (o!==cb) o.checked=false; });
            calculate();
        }));
        document.querySelectorAll('input[name="fbrK"]').forEach(cb => cb.addEventListener('change', () => {
            if (cb.checked) document.querySelectorAll('input[name="fbrK"]').forEach(o => { if (o!==cb) o.checked=false; });
            calculate();
        }));

        // Structure checkbox logic
        document.getElementById('structureCheckbox').addEventListener('change', function() {
            document.getElementById('structureInputs').style.display = this.checked ? 'grid' : 'none';
            calculate();
        });

        // Naqsha checkbox logic
        document.getElementById('naqshaCheckbox').addEventListener('change', calculate);

        // Square feet input listener for manual editing
        document.getElementById('totalSquareFeet').addEventListener('input', function() {
            isSquareFeetManual = true;
            calculate();
        });

        // Land input listener - reset manual square feet flag if land changes
        document.getElementById('landInput').addEventListener('input', function() {
            isSquareFeetManual = false;
            calculate();
        });

        // Non-govt charges input listeners
        document.getElementById('nonGovtCharges1').addEventListener('input', calculate);
        document.getElementById('nonGovtCharges2').addEventListener('input', calculate);

        // Input listeners
        document.querySelectorAll('input').forEach(el => {
            if (el.id !== 'totalSquareFeet' && el.id !== 'landInput' && 
                el.id !== 'nonGovtCharges1' && el.id !== 'nonGovtCharges2') {
                el.addEventListener('input', calculate);
            }
        });
        document.querySelectorAll('input[type="radio"]').forEach(el => el.addEventListener('change', calculate));
        document.querySelectorAll('input[type="checkbox"]').forEach(el => {
            if (el.id !== 'naqshaCheckbox' && el.id !== 'structureCheckbox') {
                el.addEventListener('change', calculate);
            }
        });

        // Print button
        document.getElementById('printBtn').addEventListener('click', () => {
            // Store current DC rate for quotation
            currentDCRate = document.getElementById('dcRate').value;
            
            // Set the area field in the modal to the land value
            document.getElementById('clientArea').value = document.getElementById('landInput').value || "Not specified";
            
            // Show the modal
            document.getElementById('quotationModal').style.display = 'flex';
            setTimeout(()=>document.getElementById('clientName').focus(), 50);
        });

        document.getElementById('modalCancel').addEventListener('click', () => {
            document.getElementById('quotationModal').style.display = 'none';
        });

        // Reset button
        document.getElementById('resetBtn').addEventListener('click', () => {
            document.getElementById('landInput').value = "";
            document.getElementById('dcRate').value = "";
            document.getElementById('totalValue').value = "0";
            document.getElementById('customValue').value = "0";
            document.getElementById('nonGovtCharges1').value = "0";
            document.getElementById('nonGovtCharges2').value = "0";
            document.getElementById('structureCheckbox').checked = false;
            document.getElementById('structureInputs').style.display = 'none';
            document.getElementById('structureRate').value = "0";
            document.getElementById('totalSquareFeet').value = "0";
            document.getElementById('totalStructureValue').value = "0";
            document.getElementById('naqshaCheckbox').checked = false;
            document.getElementById('naqshaFee').innerText = "0";
            document.querySelectorAll('input[name="dcType"]')[0].checked = true;
            
            // Reset manual square feet flag
            isSquareFeetManual = false;
            
            // Set stamp duty based on current source type
            if (currentSourceType === "urban") {
                document.querySelector('input[name="stamp"][value="1"]').checked = true;
            } else {
                document.querySelector('input[name="stamp"][value="3"]').checked = true;
            }
            
            document.querySelectorAll('input[name="fbrC"]').forEach(cb => cb.checked = false);
            document.querySelectorAll('input[name="fbrK"]').forEach(cb => cb.checked = false);
            
            // Reset global variables
            currentDCRate = "";
            currentDCType = "marla";
            structureRate = 0;
            
            calculate();
        });

        // PDF generation with improved text layout
        document.getElementById('sendBtn').addEventListener('click', () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const nameRaw = document.getElementById('clientName').value || "Client";
            const name = nameRaw.trim() ? nameRaw.trim() : "Client";
            const area = document.getElementById('clientArea').value || "";
            const address = document.getElementById('clientAddress').value || "";

            // Header with business name and date
            doc.setFillColor(40, 167, 69);
            doc.rect(0, 0, 210, 35, 'F');
            
            // Business name
            doc.setFontSize(20);
            doc.setTextColor(255, 255, 255);
            doc.setFont(undefined, 'bold');
            doc.text("STARFIELD PROPERTIES", 105, 18, { align: "center" });
            
            // Subtitle
            doc.setFontSize(14);
            doc.text("ABDUL SATTAR | +92 300 2829440", 105, 25, { align: "center" });
            
            // Date
            doc.setFontSize(10);
            doc.text("Date: " + new Date().toLocaleDateString(), 190, 12, { align: "right" });
            
            // Client details section with improved layout
            const clientStartY = 45;
            const boxWidth = 90;
            const boxHeight = 60; // Fixed height
            
            // Client details box with rounded corners
            doc.setFillColor(227, 242, 253);
            doc.roundedRect(10, clientStartY, boxWidth, boxHeight, 5, 5, 'F');
            
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text("CLIENT DETAILS", 15, clientStartY + 8);
            doc.setFont(undefined, 'normal');
            
            // Client details with better spacing
            let currentY = clientStartY + 16;
            
            // Name field
            doc.text("Name:", 15, currentY);
            const nameLines = doc.splitTextToSize(name, 50);
            doc.text(nameLines, 40, currentY);
            currentY += Math.max(6, nameLines.length * 5);
            
            // Address field
            doc.text("Address:", 15, currentY);
            const addressLines = doc.splitTextToSize(address || "Not specified", 50);
            doc.text(addressLines, 40, currentY);
            currentY += Math.max(6, addressLines.length * 5);
            
            // Area field
            doc.text("Area:", 15, currentY);
            doc.text(area || "Not specified", 40, currentY);
            
            // Property details section with improved layout
            doc.setFillColor(232, 245, 233);
            doc.roundedRect(110, clientStartY, boxWidth, boxHeight, 5, 5, 'F');
            
            doc.setFont(undefined, 'bold');
            doc.text("PROPERTY DETAILS", 120, clientStartY + 8);
            doc.setFont(undefined, 'normal');
            
            // Determine land status based on conditions
            let landStatus = "PLOT";
            if (currentDCType === "acre") {
                landStatus = "Zarai Zameen";
            } else if (document.getElementById('structureCheckbox').checked) {
                landStatus = "Tameer Shuda";
            }
            
            // Property details with better spacing
            currentY = clientStartY + 16;
            
            const areaLabel = currentSourceType === "rural" ? "Mauza" : "Property Area";
            doc.text(areaLabel + ":", 120, currentY);
            const areaLines = doc.splitTextToSize(mauzaOrPropertyArea || area || "Not specified", 40);
            doc.text(areaLines, 155, currentY);
            currentY += Math.max(6, areaLines.length * 5);
            
            doc.text("Location:", 120, currentY);
            const locationLines = doc.splitTextToSize(propertyLocation || "Not specified", 40);
            doc.text(locationLines, 155, currentY);
            currentY += Math.max(6, locationLines.length * 5);
            
            doc.text("Classification:", 120, currentY);
            doc.text(currentSourceType === "rural" ? "Rural" : "Urban", 155, currentY);
            currentY += 6;
            
            doc.text("DC Rate:", 120, currentY);
            const dcRateLines = doc.splitTextToSize(currentDCRate + " (" + (currentDCType === "marla" ? "Per Marla" : "Per Acre") + ")", 40);
            doc.text(dcRateLines, 155, currentY);
            currentY += Math.max(6, dcRateLines.length * 5);
            
            // Status at the end
            doc.text("Status:", 120, currentY);
            doc.text(landStatus, 155, currentY);
            
            // Add structure details if enabled
            if (document.getElementById('structureCheckbox').checked) {
                currentY += 6;
                const squareFeetRaw = (document.getElementById('totalSquareFeet').value || "").replace(/,/g, "").trim();
                const squareFeet = parseFloat(squareFeetRaw) || 0;
                doc.text("Construction:", 120, currentY);
                doc.text(formatIndian(squareFeet) + " Sq Ft", 155, currentY);
                currentY += 6;
                doc.text("Structure Rate:", 120, currentY);
                doc.text(formatIndian(structureRate) + "/Sq Ft", 155, currentY);
            }
            
            // Line separator before table
            const tableStartY = clientStartY + boxHeight + 10;
            doc.setDrawColor(200, 200, 200);
            doc.setLineWidth(0.5);
            doc.line(10, tableStartY, 200, tableStartY);
            
            // Collect values and percentages
            const stampPercent = parseFloat((document.querySelector('input[name="stamp"]:checked') || {}).value) || 0;
            const fbrCBox = document.querySelector('input[name="fbrC"]:checked');
            const fbrCPercent = fbrCBox ? parseFloat(fbrCBox.value) : 0;
            const fbrKBox = document.querySelector('input[name="fbrK"]:checked');
            const fbrKPercent = fbrKBox ? parseFloat(fbrKBox.value) : 0;
            const naqshaEnabled = document.getElementById('naqshaCheckbox').checked;

            // Use Custom Value if available, otherwise use System Value
            const customRaw = (document.getElementById('customValue').value || "").replace(/,/g,"").trim();
            const customValue = parseFloat(customRaw);
            const hasCustomValue = !isNaN(customValue) && customValue > 0;
            
            // Prepare table rows with proper formatting
            const rows = [
                ["Particulars", "%", "Amount (Rs)"]
            ];
            
            // Add value details
            if (document.getElementById('structureCheckbox').checked) {
                // Land value
                const landValue = systemValue - (document.getElementById('totalStructureValue').value.replace(/,/g, "") || 0);
                rows.push(["Land Value", "-", formatIndian(landValue)]);
                
                // Structure value
                rows.push(["Structure Value", "-", document.getElementById('totalStructureValue').value]);
            }
            
            // Total value (system or custom)
            if (hasCustomValue) {
                rows.push(["Total Value (Custom)", "-", document.getElementById('customValue').value]);
            } else {
                rows.push(["Total Value (System)", "-", document.getElementById('totalValue').value]);
            }
            
            // Add charges with percentages
            rows.push(["Stamp Duty", stampPercent > 0 ? stampPercent + "%" : "-", document.getElementById('stampDuty').innerText]);
            rows.push(["Local Govt Fee", "1%", document.getElementById('districtCouncil').innerText]);
            
            if (fbrCPercent > 0) {
                rows.push(["FBR 236C", fbrCPercent + "%", document.getElementById('fbrC').innerText]);
            } else {
                rows.push(["FBR 236C", "-", "-"]);
            }
            
            if (fbrKPercent > 0) {
                rows.push(["FBR 236K", fbrKPercent + "%", document.getElementById('fbrK').innerText]);
            } else {
                rows.push(["FBR 236K", "-", "-"]);
            }
            
            rows.push(["PLRA Charges", "-", document.getElementById('plraCharges').innerText]);
            rows.push(["Registration Charges", "-", document.getElementById('regCharges').innerText]);
            
            // Add Naqsha Fee if enabled
            if (naqshaEnabled) {
                rows.push(["Naqsha Fee", "2%", document.getElementById('naqshaFee').innerText]);
            }
            
            // Add non-govt charges
            const nonGovtCharges1 = document.getElementById('nonGovtCharges1').value || "0";
            if (nonGovtCharges1 !== "0") {
                rows.push(["Ahl-Commission Fee", "-", nonGovtCharges1]);
            }
            
            const nonGovtCharges2 = document.getElementById('nonGovtCharges2').value || "0";
            if (nonGovtCharges2 !== "0") {
                rows.push(["Misc. & Service Charges", "-", nonGovtCharges2]);
            }
            
            const final = document.getElementById('finalAmount').innerText;

            // Table with colored header
            let startY = tableStartY + 10;
            doc.setFontSize(11);
            
            // Table header with color
            doc.setFillColor(200, 200, 200);
            doc.rect(10, startY, 190, 8, "F");
            doc.setTextColor(0, 0, 0);
            doc.text("Particulars", 15, startY + 6);
            doc.text("%", 150, startY + 6, { align: "center" });
            doc.text("Amount (Rs)", 200, startY + 6, { align: "right" });
            startY += 10;
            
            // Table rows
            doc.setFontSize(10);
            for (let i = 1; i < rows.length; i++) {
                const [item, percentage, amount] = rows[i];
                
                // Split long text into multiple lines
                const splitItem = doc.splitTextToSize(item, 80);
                const splitPercentage = doc.splitTextToSize(percentage, 15);
                const splitAmount = doc.splitTextToSize(amount, 30);
                
                const itemHeight = splitItem.length * 4;
                const percentageHeight = splitPercentage.length * 4;
                const amountHeight = splitAmount.length * 4;
                const rowHeight = Math.max(itemHeight, percentageHeight, amountHeight, 7);
                
                doc.text(splitItem, 15, startY + 3);
                doc.text(splitPercentage, 150, startY + 3, { align: "center" });
                doc.text(splitAmount, 200, startY + 3, { align: "right" });
                
                startY += rowHeight;
                
                // Add a separator line after the value section
                if (i === (document.getElementById('structureCheckbox').checked ? 3 : 1)) {
                    startY += 2;
                    doc.setDrawColor(150, 150, 150);
                    doc.setLineWidth(0.3);
                    doc.line(10, startY, 200, startY);
                    startY += 4;
                }
            }

            // Solid thin line before total
            startY += 2;
            doc.setDrawColor(150, 150, 150);
            doc.setLineWidth(0.3);
            doc.line(10, startY, 200, startY);
            startY += 4;

            // Total with colored background and rounded corners
            doc.setFillColor(243, 229, 245);
            doc.roundedRect(10, startY, 190, 10, 3, 3, 'F');
            doc.setFontSize(12);
            doc.setFont(undefined, "bold");
            doc.setTextColor(30, 126, 52);
            doc.text("Grand Total", 15, startY + 7);
            doc.text("Rs " + final, 200, startY + 7, { align: "right" });

            // Footer
            startY += 20;
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text("This is a computer generated quotation.", 105, startY, { align: "center" });
            startY += 5;
            doc.text("For STARFIELD PROPERTIES", 105, startY, { align: "center" });
            startY += 5;
            doc.text("Chamber No. 31, Tehsil Courts, Depalpur", 105, startY, { align: "center" });

            const safeName = name.replace(/[\/\\:*?"<>|]/g, '_');
            doc.save(`Quotation_${safeName}.pdf`);
            document.getElementById('quotationModal').style.display = 'none';
        });

        // Parent message listener
        window.addEventListener("message", (event) => {
            if (event.data && typeof event.data === 'object' && event.data.dcRate) {
                let incomingDcRate = event.data.dcRate;
                if (typeof incomingDcRate === 'string') incomingDcRate = incomingDcRate.replace(/,/g, '').trim();
                let numeric = parseFloat(incomingDcRate);
                document.getElementById('dcRate').value = !isNaN(numeric) ? formatIndian(numeric) : incomingDcRate;

                let source = (event.data.sourceType || "").toLowerCase();
                currentSourceType = source;
                let unit   = (event.data.unit || "").toLowerCase();

                // Set DC type based on unit
                if (unit.includes("marla")) {
                    document.querySelector('input[name="dcType"][value="marla"]').checked = true;
                } else if (unit.includes("acre")) {
                    document.querySelector('input[name="dcType"][value="acre"]').checked = true;
                }

                // Set stamp duty based on source type
                if (source === "urban") {
                    document.querySelector('input[name="stamp"][value="1"]').checked = true;
                } else if (source === "rural") {
                    document.querySelector('input[name="stamp"][value="3"]').checked = true;
                }
                
                // Get structure Rate if provided
                if (event.data.structureRate) {
                    structureRate = parseFloat(event.data.structureRate) || 0;
                    document.getElementById('structureRate').value = formatIndian(structureRate);
                }
                
                // Get property location and mauza/property area if provided
                if (event.data.location) {
                    propertyLocation = event.data.location;
                }
                
                if (source === "rural" && event.data.mauza) {
                    mauzaOrPropertyArea = event.data.mauza;
                } else if (source === "urban" && event.data.propertyArea) {
                    mauzaOrPropertyArea = event.data.propertyArea;
                }
                
                calculate();
            }
        });

        // Initialize with urban settings (1% stamp duty)
        document.querySelector('input[name="stamp"][value="1"]').checked = true;
        // Set Naqsha checkbox to unchecked by default
        document.getElementById('naqshaCheckbox').checked = false;
        window.addEventListener('load', calculate);
    </script>
</body>
</html>